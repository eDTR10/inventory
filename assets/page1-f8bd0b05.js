import{c as G,r as m,a as C,j as e,X as ne,B as F,_ as re,u as le,b as oe,N as ie}from"./index-bf3ea27a.js";import{I as H}from"./input-291a3ddc.js";import{Q as ce}from"./qr-code-c9ca2d18.js";const B=G("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]),de=G("ExternalLink",[["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}],["polyline",{points:"15 3 21 3 21 9",key:"mznyad"}],["line",{x1:"10",x2:"21",y1:"14",y2:"3",key:"18c3s4"}]]),me=()=>{const[o,p]=m.useState([]),[y,f]=m.useState(!1),[q,c]=m.useState(null),g=m.useCallback(async()=>{f(!0),c(null);try{const t=await C.get("inventory/items/");return p(t.data),t.data}catch(t){const s=t instanceof Error?t.message:"Failed to fetch items";throw c(s),t}finally{f(!1)}},[]),_=m.useCallback(async t=>{c(null);try{return(await C.get(`inventory/items/${t}/`)).data}catch(s){const a=s instanceof Error?s.message:"Failed to get item";throw c(a),s}},[]),$=m.useCallback(async t=>{c(null);try{const s=t instanceof FormData?{headers:{"Content-Type":"multipart/form-data"}}:{},a=await C.post("inventory/items/",t,s);return await g(),a.data}catch(s){const a=s instanceof Error?s.message:"Failed to add item";throw c(a),s}},[g]),i=m.useCallback(async(t,s)=>{c(null);try{const a=s instanceof FormData?{headers:{"Content-Type":"multipart/form-data"}}:{};await C.patch(`inventory/items/${t}/`,s,a),await g()}catch(a){const x=a instanceof Error?a.message:"Failed to update item";throw c(x),a}},[g]),j=m.useCallback(async(t,s=1)=>{c(null);try{const a=o.find(x=>x.id===t);if(!a)throw new Error("Item not found");await C.patch(`inventory/items/${t}/`,{quantity:a.quantity+s}),await g()}catch(a){const x=a instanceof Error?a.message:"Failed to increase quantity";throw c(x),a}},[g,o]),u=m.useCallback(async(t,s=1)=>{c(null);try{const a=o.find(R=>R.id===t);if(!a)throw new Error("Item not found");const x=Math.max(0,a.quantity-s);await C.patch(`inventory/items/${t}/`,{quantity:x}),await g()}catch(a){const x=a instanceof Error?a.message:"Failed to decrease quantity";throw c(x),a}},[g,o]),v=m.useCallback(async t=>{c(null);try{await C.delete(`inventory/items/${t}/`),await g()}catch(s){const a=s instanceof Error?s.message:"Failed to delete item";throw c(a),s}},[g]),w=m.useCallback(async t=>{c(null);try{return(await C.get(`inventory/items/${t}/logs/`)).data}catch(s){const a=s instanceof Error?s.message:"Failed to get logs";throw c(a),s}},[]),Q=m.useCallback(async t=>{c(null);try{const s=new URLSearchParams;return t!=null&&t.item_id&&s.append("item_id",t.item_id.toString()),t!=null&&t.user_id&&s.append("user_id",t.user_id.toString()),t!=null&&t.action&&s.append("action",t.action),(await C.get(`inventory/logs/?${s.toString()}`)).data}catch(s){const a=s instanceof Error?s.message:"Failed to get logs";throw c(a),s}},[]);return{items:o,loading:y,error:q,fetchItems:g,getItem:_,addItem:$,updateItem:i,addQuantity:j,removeQuantity:u,deleteItem:v,getItemLogs:w,getLogs:Q}},xe=o=>`https://edtr10.github.io/inventory/item/${encodeURIComponent(o)}`,K=(o,p=200)=>{const y=xe(o),f=encodeURIComponent(y);return`https://api.qrserver.com/v1/create-qr-code/?size=${p}x${p}&data=${f}&margin=15`},he=({itemName:o,itemId:p,onClose:y})=>{const[f,q]=m.useState(300),c=`https://edtr10.github.io//inventory/item/${p||encodeURIComponent(o)}`,g=K((p==null?void 0:p.toString())||o,f),_=async()=>{try{const j=await(await fetch(g)).blob(),u=new Image;u.onload=()=>{const v=document.createElement("canvas"),w=30,Q=60,t=u.width+w*2,s=u.height+w*2+Q,a=v.getContext("2d");a&&(v.width=t,v.height=s,a.fillStyle="white",a.fillRect(0,0,t,s),a.drawImage(u,w,w),a.fillStyle="#1f2937",a.font="bold 20px Arial, sans-serif",a.textAlign="center",a.fillText(`${o}`,t/2,u.height+w+45),v.toBlob(x=>{if(x){const R=window.URL.createObjectURL(x),E=document.createElement("a");E.href=R,E.download=`${o}-qrcode.png`,document.body.appendChild(E),E.click(),window.URL.revokeObjectURL(R),document.body.removeChild(E)}}))},u.src=URL.createObjectURL(j)}catch(i){console.error("Failed to download QR code:",i)}},$=()=>{window.open(c,"_blank")};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 rounded-lg shadow-xl p-6 max-w-md w-full mx-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"QR Code Link"}),y&&e.jsx("button",{onClick:y,className:"p-1 hover:bg-gray-100 dark:hover:bg-slate-800 rounded",children:e.jsx(ne,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-4",children:["Item: ",e.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:o})]}),e.jsx("div",{className:"bg-white p-4 rounded border border-gray-200 flex items-center justify-center mb-4",children:e.jsx("img",{src:g,alt:`QR Code for ${o}`,className:"w-full"})}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Size (px)"}),e.jsx("input",{type:"range",min:"150",max:"500",step:"50",value:f,onChange:i=>q(parseInt(i.target.value)),className:"w-full"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[f,"x",f,"px"]})]}),e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 dark:bg-slate-800 rounded border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-xs font-medium text-gray-900 dark:text-white mb-2",children:"Link:"}),e.jsx("p",{className:"text-xs text-gray-700 dark:text-gray-300 break-all font-mono",children:c})]}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-slate-800 p-3 rounded mb-4",children:"ðŸ“± Scan this QR code to open the item page where users can add or deduct quantities from their mobile device!"})]}),e.jsxs("div",{className:"flex gap-2 flex-col",children:[e.jsxs(F,{onClick:_,className:"w-full",variant:"default",children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"Download QR Code"]}),e.jsxs(F,{onClick:$,variant:"outline",className:"w-full",children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),"Open Item Link"]}),y&&e.jsx(F,{onClick:y,variant:"outline",className:"w-full",children:"Close"})]})]})})},ge=()=>{const{items:o,loading:p,error:y,fetchItems:f,addItem:q,updateItem:c,deleteItem:g,addQuantity:_,removeQuantity:$}=me(),[i,j]=m.useState({name:"",img:null,url:"",quantity:0}),[u,v]=m.useState(null),[w,Q]=m.useState(null),[t,s]=m.useState(!1),[a,x]=m.useState(null);m.useEffect(()=>{f().catch(n=>console.error("Failed to fetch items:",n))},[f]);const R=n=>{const{name:l,value:r}=n.target;j(d=>({...d,[l]:l==="quantity"?parseInt(r)||0:r}))},E=async n=>{var r;const l=((r=n.target.files)==null?void 0:r[0])||null;if(!l){j(d=>({...d,img:null})),x(null);return}try{const d=await V(l);j(h=>({...h,img:d}));const S=new FileReader;S.onloadend=()=>{x(S.result)},S.readAsDataURL(d)}catch(d){console.error("Failed to compress image:",d),alert("Failed to process image. Please try a different file.")}},V=n=>new Promise((l,r)=>{const d=new FileReader;d.readAsDataURL(n),d.onload=S=>{var L;const h=new Image;h.src=(L=S.target)==null?void 0:L.result,h.onload=()=>{let b=h.width,N=h.height;b>N?b>1024&&(N=N*1024/b,b=1024):N>1024&&(b=b*1024/N,N=1024);const k=document.createElement("canvas");k.width=b,k.height=N;const D=k.getContext("2d");if(!D){r(new Error("Failed to get canvas context"));return}D.drawImage(h,0,0,b,N),k.toBlob(A=>{if(!A){r(new Error("Failed to compress image"));return}const I=new File([A],n.name,{type:"image/jpeg",lastModified:Date.now()});console.log(`Original size: ${(n.size/1024).toFixed(2)}KB, Compressed size: ${(I.size/1024).toFixed(2)}KB`),l(I)},"image/jpeg",.8)},h.onerror=()=>{r(new Error("Failed to load image"))}},d.onerror=()=>{r(new Error("Failed to read file"))}}),Y=async n=>{if(n.preventDefault(),!i.name.trim()){alert("Please enter an item name");return}try{if(u){const l={};if(i.name&&(l.name=i.name),i.url&&(l.url=i.url),i.quantity!==void 0&&(l.quantity=i.quantity),i.img){const r=new FormData;Object.keys(l).forEach(d=>{r.append(d,l[d])}),r.append("img",i.img),await c(u,r)}else await c(u,l);v(null)}else{const l={name:i.name,quantity:i.quantity};if(i.url&&(l.url=i.url),i.img){const r=new FormData;Object.keys(l).forEach(d=>{r.append(d,l[d])}),r.append("img",i.img),await q(r)}else await q(l)}j({name:"",img:null,url:"",quantity:0}),x(null)}catch(l){console.error("Failed to save item:",l)}},J=n=>{j({name:n.name,img:null,url:n.url||"",quantity:n.quantity}),v(n.id),n.img&&x(n.img)},Z=async(n,l)=>{if(window.confirm(`Delete "${l}"?`))try{await g(n)}catch(r){console.error("Failed to delete item:",r)}},O=async(n,l)=>{try{l==="add"?await _(n,1):await $(n,1)}catch(r){console.error("Failed to change quantity:",r)}},ee=async()=>{var n;if(o.length===0){alert("No items to download");return}if(!t){s(!0);try{const l=(await re(()=>import("./jspdf.es.min-23c78daa.js").then(I=>I.j),["assets/jspdf.es.min-23c78daa.js","assets/index-bf3ea27a.js","assets/index-4a65fdae.css"])).jsPDF,r=new l({orientation:"portrait",unit:"mm",format:"a4"}),d=r.internal.pageSize.getWidth(),S=r.internal.pageSize.getHeight(),h=10,L=50,W=70,U=3,b=(d-h*2)/U;let N=1,k=0;r.setFontSize(16),r.text("Inventory QR Codes",h,h),r.setFontSize(10),r.text(`Generated: ${new Date().toLocaleDateString()}`,h,h+7);let D=h+15;const A=S-h;for(let I=0;I<o.length;I++){const P=o[I],te=I%U,X=h+te*b;try{const z=K(((n=P.id)==null?void 0:n.toString())||P.name,200),ae=await(await fetch(z)).blob(),T=new FileReader;await new Promise(se=>{T.onload=()=>{try{const M=T.result;r.addImage(M,"PNG",X+5,D,L,L),r.setFontSize(8),r.text(P.name,X+b/2,D+L+8,{align:"center",maxWidth:b-10}),k++,(k%U===0||k===o.length)&&(D+=W,D>A&&k<o.length&&(r.addPage(),N++,D=h))}catch(M){console.error(`Failed to add QR code for ${P.name}:`,M)}se()},T.readAsDataURL(ae)})}catch(z){console.error(`Failed to load QR code for ${P.name}:`,z)}}r.save(`inventory-qr-codes-${new Date().toISOString().split("T")[0]}.pdf`)}catch(l){console.error("Failed to download QR codes:",l),alert("Failed to download QR codes as PDF")}finally{s(!1)}}};return e.jsxs("div",{className:"p-8 lg:p-6 md:p-4 max-w-7xl mx-auto",children:[e.jsx("h1",{className:"text-3xl md:text-2xl font-bold mb-8 md:mb-6",children:"Inventory Management"}),y&&e.jsxs("div",{className:"mb-4 p-4 bg-red-100 text-red-700 rounded",children:["Error: ",y]}),e.jsxs("form",{onSubmit:Y,className:"mb-8 md:mb-6 p-6 md:p-4 bg-gray-50 rounded-lg border",children:[e.jsx("h2",{className:"text-xl md:text-lg font-semibold mb-4",children:u?"Edit Item":"Add New Item"}),e.jsxs("div",{className:"grid grid-cols-4 lg:grid-cols-2 md:grid-cols-1 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Item Name *"}),e.jsx(H,{type:"text",name:"name",value:i.name,onChange:R,placeholder:"e.g., Sack Bag",disabled:!!u})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Image"}),e.jsx(H,{type:"file",name:"img",onChange:E,accept:"image/*",className:"cursor-pointer"}),a&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:a,alt:"Preview",className:"h-20 w-20 object-cover rounded border"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"URL"}),e.jsx(H,{type:"text",name:"url",value:i.url,onChange:R,placeholder:"https://example.com"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Quantity"}),e.jsx(H,{type:"number",name:"quantity",value:i.quantity,onChange:R,placeholder:"0"})]})]}),e.jsxs("div",{className:"flex gap-2 md:flex-col",children:[e.jsx(F,{type:"submit",className:"md:w-full",children:u?"Update Item":"Add Item"}),u&&e.jsx(F,{type:"button",variant:"outline",className:"md:w-full",onClick:()=>{v(null),j({name:"",img:null,url:"",quantity:0}),x(null)},children:"Cancel"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between md:flex-col md:gap-3 mb-4",children:[e.jsxs("h2",{className:"text-xl md:text-lg font-semibold",children:["Inventory Items (",o.length,")"]}),o.length>0&&e.jsx(F,{onClick:ee,disabled:t,className:"gap-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed md:w-full",children:t?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"inline-block animate-spin",children:"â³"}),"Generating PDF..."]}):e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"w-4 h-4"}),"Download All QR Codes (PDF)"]})})]}),p?e.jsx("p",{className:"text-gray-600",children:"Loading items..."}):o.length===0?e.jsx("p",{className:"text-gray-600",children:"No items in inventory"}):e.jsx("div",{className:"overflow-x-auto md:-mx-4",children:e.jsx("div",{className:"inline-block min-w-full align-middle",children:e.jsxs("table",{className:"min-w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-200",children:[e.jsx("th",{className:"border p-3 md:p-2 text-left text-sm md:text-xs",children:"Item Name"}),e.jsx("th",{className:"border p-3 md:p-2 text-left text-sm md:text-xs",children:"Image"}),e.jsx("th",{className:"border p-3 md:p-2 text-left text-sm md:text-xs slg:hidden",children:"URL"}),e.jsx("th",{className:"border p-3 md:p-2 text-right text-sm md:text-xs",children:"Quantity"}),e.jsx("th",{className:"border p-3 md:p-2 text-center text-sm md:text-xs lg:hidden",children:"QR Code"}),e.jsx("th",{className:"border p-3 md:p-2 text-center text-sm md:text-xs",children:"Actions"})]})}),e.jsx("tbody",{children:o.map(n=>e.jsxs("tr",{className:"border hover:bg-gray-50",children:[e.jsx("td",{className:"border p-3 md:p-2 font-medium text-sm md:text-xs",children:n.name}),e.jsx("td",{className:"border p-3 md:p-2",children:n.img?e.jsx("div",{className:"flex justify-center",children:e.jsx("img",{src:n.img,alt:n.name,className:"w-[150px] h-[150px] object-contain rounded border"})}):e.jsx("div",{className:"flex justify-center items-center w-[150px] h-[150px]",children:e.jsx("span",{className:"text-gray-400 text-xs",children:"No image"})})}),e.jsx("td",{className:"border p-3 md:p-2 slg:hidden",children:n.url?e.jsx("a",{href:n.url,target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline text-sm md:text-xs",children:"Link"}):e.jsx("span",{className:"text-gray-400 text-sm md:text-xs",children:"-"})}),e.jsx("td",{className:"border p-3 md:p-2 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2 md:gap-1",children:[e.jsx("button",{onClick:()=>O(n.id,"remove"),className:"px-2 py-1 md:px-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm md:text-xs",children:"-"}),e.jsx("span",{className:"w-8 md:w-6 text-center font-semibold text-sm md:text-xs",children:n.quantity}),e.jsx("button",{onClick:()=>O(n.id,"add"),className:"px-2 py-1 md:px-1.5 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm md:text-xs",children:"+"})]})}),e.jsx("td",{className:"border p-3 md:p-2 text-center lg:hidden",children:e.jsxs(F,{size:"sm",variant:"outline",onClick:()=>Q({name:n.name,id:n.id}),className:"gap-2 text-xs",children:[e.jsx(ce,{className:"w-4 h-4 md:w-3 md:h-3"}),e.jsx("span",{className:"slg:hidden",children:"Show QR"}),e.jsx("span",{className:"hidden slg:inline",children:"QR"})]})}),e.jsx("td",{className:"border p-3 md:p-2 text-center",children:e.jsxs("div",{className:"flex gap-2 md:gap-1 justify-center lg:flex-col",children:[e.jsx(F,{size:"sm",variant:"outline",onClick:()=>J(n),className:"text-xs lg:w-full",children:"Edit"}),e.jsx(F,{size:"sm",variant:"outline",onClick:()=>Z(n.id,n.name),className:"text-red-600 hover:text-red-700 text-xs lg:w-full",children:"Delete"})]})})]},n.id))})]})})})]}),w&&e.jsx(he,{itemName:w.name,itemId:w.id,onClose:()=>Q(null)})]})},ue=({children:o})=>{const{isAuthenticated:p,isLoading:y}=le(),f=oe();return y?e.jsx("div",{className:"min-h-screen w-full flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):p?e.jsx(e.Fragment,{children:o}):e.jsx(ie,{to:"/login",state:{from:f},replace:!0})},we=()=>e.jsx("div",{className:" min-h-full w-full max-w-[1468px]  flex flex-col justify-center",children:e.jsx(ue,{children:e.jsx(ge,{})})});export{we as default};
