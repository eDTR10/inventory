import{c as X,r as m,a as F,j as e,X as se,B as R,_ as ne,u as re,b as le,N as oe}from"./index-bbf9b331.js";import{I as H}from"./input-626c7032.js";import{Q as ie}from"./qr-code-49e25e97.js";const G=X("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]),ce=X("ExternalLink",[["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}],["polyline",{points:"15 3 21 3 21 9",key:"mznyad"}],["line",{x1:"10",x2:"21",y1:"14",y2:"3",key:"18c3s4"}]]),de=()=>{const[l,w]=m.useState([]),[f,p]=m.useState(!1),[q,i]=m.useState(null),h=m.useCallback(async()=>{p(!0),i(null);try{const t=await F.get("inventory/items/");return w(t.data),t.data}catch(t){const s=t instanceof Error?t.message:"Failed to fetch items";throw i(s),t}finally{p(!1)}},[]),L=m.useCallback(async t=>{i(null);try{return(await F.get(`inventory/items/${t}/`)).data}catch(s){const a=s instanceof Error?s.message:"Failed to get item";throw i(a),s}},[]),_=m.useCallback(async t=>{i(null);try{const s=t instanceof FormData?{headers:{"Content-Type":"multipart/form-data"}}:{},a=await F.post("inventory/items/",t,s);return await h(),a.data}catch(s){const a=s instanceof Error?s.message:"Failed to add item";throw i(a),s}},[h]),o=m.useCallback(async(t,s)=>{i(null);try{const a=s instanceof FormData?{headers:{"Content-Type":"multipart/form-data"}}:{};await F.patch(`inventory/items/${t}/`,s,a),await h()}catch(a){const x=a instanceof Error?a.message:"Failed to update item";throw i(x),a}},[h]),v=m.useCallback(async(t,s=1)=>{i(null);try{const a=l.find(x=>x.id===t);if(!a)throw new Error("Item not found");await F.patch(`inventory/items/${t}/`,{quantity:a.quantity+s}),await h()}catch(a){const x=a instanceof Error?a.message:"Failed to increase quantity";throw i(x),a}},[h,l]),g=m.useCallback(async(t,s=1)=>{i(null);try{const a=l.find(D=>D.id===t);if(!a)throw new Error("Item not found");const x=Math.max(0,a.quantity-s);await F.patch(`inventory/items/${t}/`,{quantity:x}),await h()}catch(a){const x=a instanceof Error?a.message:"Failed to decrease quantity";throw i(x),a}},[h,l]),N=m.useCallback(async t=>{i(null);try{await F.delete(`inventory/items/${t}/`),await h()}catch(s){const a=s instanceof Error?s.message:"Failed to delete item";throw i(a),s}},[h]),j=m.useCallback(async t=>{i(null);try{return(await F.get(`inventory/items/${t}/logs/`)).data}catch(s){const a=s instanceof Error?s.message:"Failed to get logs";throw i(a),s}},[]),Q=m.useCallback(async t=>{i(null);try{const s=new URLSearchParams;return t!=null&&t.item_id&&s.append("item_id",t.item_id.toString()),t!=null&&t.user_id&&s.append("user_id",t.user_id.toString()),t!=null&&t.action&&s.append("action",t.action),(await F.get(`inventory/logs/?${s.toString()}`)).data}catch(s){const a=s instanceof Error?s.message:"Failed to get logs";throw i(a),s}},[]);return{items:l,loading:f,error:q,fetchItems:h,getItem:L,addItem:_,updateItem:o,addQuantity:v,removeQuantity:g,deleteItem:N,getItemLogs:j,getLogs:Q}},me=l=>`https://edtr10.github.io/inventory/item/${encodeURIComponent(l)}`,B=(l,w=200)=>{const f=me(l),p=encodeURIComponent(f);return`https://api.qrserver.com/v1/create-qr-code/?size=${w}x${w}&data=${p}&margin=15`},xe=({itemName:l,itemId:w,onClose:f})=>{const[p,q]=m.useState(300),i=B(l,p),h=`${window.location.origin}/inventory/item/${w||encodeURIComponent(l)}`,L=async()=>{try{const v=await(await fetch(i)).blob(),g=new Image;g.onload=()=>{const N=document.createElement("canvas"),j=30,Q=60,t=g.width+j*2,s=g.height+j*2+Q,a=N.getContext("2d");a&&(N.width=t,N.height=s,a.fillStyle="white",a.fillRect(0,0,t,s),a.drawImage(g,j,j),a.fillStyle="#1f2937",a.font="bold 20px Arial, sans-serif",a.textAlign="center",a.fillText(`${l}`,t/2,g.height+j+45),N.toBlob(x=>{if(x){const D=window.URL.createObjectURL(x),E=document.createElement("a");E.href=D,E.download=`${l}-qrcode.png`,document.body.appendChild(E),E.click(),window.URL.revokeObjectURL(D),document.body.removeChild(E)}}))},g.src=URL.createObjectURL(v)}catch(o){console.error("Failed to download QR code:",o)}},_=()=>{window.open(h,"_blank")};return e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-slate-900 rounded-lg shadow-xl p-6 max-w-md w-full mx-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"QR Code Link"}),f&&e.jsx("button",{onClick:f,className:"p-1 hover:bg-gray-100 dark:hover:bg-slate-800 rounded",children:e.jsx(se,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400 mb-4",children:["Item: ",e.jsx("span",{className:"font-semibold text-gray-900 dark:text-white",children:l})]}),e.jsx("div",{className:"bg-white p-4 rounded border border-gray-200 flex items-center justify-center mb-4",children:e.jsx("img",{src:i,alt:`QR Code for ${l}`,className:"w-full"})}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Size (px)"}),e.jsx("input",{type:"range",min:"150",max:"500",step:"50",value:p,onChange:o=>q(parseInt(o.target.value)),className:"w-full"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:[p,"x",p,"px"]})]}),e.jsxs("div",{className:"mb-4 p-3 bg-blue-50 dark:bg-slate-800 rounded border border-blue-200 dark:border-blue-700",children:[e.jsx("p",{className:"text-xs font-medium text-gray-900 dark:text-white mb-2",children:"Link:"}),e.jsx("p",{className:"text-xs text-gray-700 dark:text-gray-300 break-all font-mono",children:h})]}),e.jsx("p",{className:"text-xs text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-slate-800 p-3 rounded mb-4",children:"ðŸ“± Scan this QR code to open the item page where users can add or deduct quantities from their mobile device!"})]}),e.jsxs("div",{className:"flex gap-2 flex-col",children:[e.jsxs(R,{onClick:L,className:"w-full",variant:"default",children:[e.jsx(G,{className:"w-4 h-4 mr-2"}),"Download QR Code"]}),e.jsxs(R,{onClick:_,variant:"outline",className:"w-full",children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Open Item Link"]}),f&&e.jsx(R,{onClick:f,variant:"outline",className:"w-full",children:"Close"})]})]})})},he=()=>{const{items:l,loading:w,error:f,fetchItems:p,addItem:q,updateItem:i,deleteItem:h,addQuantity:L,removeQuantity:_}=de(),[o,v]=m.useState({name:"",img:null,url:"",quantity:0}),[g,N]=m.useState(null),[j,Q]=m.useState(null),[t,s]=m.useState(!1),[a,x]=m.useState(null);m.useEffect(()=>{p().catch(n=>console.error("Failed to fetch items:",n))},[p]);const D=n=>{const{name:r,value:c}=n.target;v(d=>({...d,[r]:r==="quantity"?parseInt(c)||0:c}))},E=async n=>{var c;const r=((c=n.target.files)==null?void 0:c[0])||null;if(!r){v(d=>({...d,img:null})),x(null);return}try{const d=await K(r);v(b=>({...b,img:d}));const u=new FileReader;u.onloadend=()=>{x(u.result)},u.readAsDataURL(d)}catch(d){console.error("Failed to compress image:",d),alert("Failed to process image. Please try a different file.")}},K=n=>new Promise((r,c)=>{const d=new FileReader;d.readAsDataURL(n),d.onload=u=>{var $;const b=new Image;b.src=($=u.target)==null?void 0:$.result,b.onload=()=>{let I=b.width,y=b.height;I>y?I>1024&&(y=y*1024/I,I=1024):y>1024&&(I=I*1024/y,y=1024);const k=document.createElement("canvas");k.width=I,k.height=y;const A=k.getContext("2d");if(!A){c(new Error("Failed to get canvas context"));return}A.drawImage(b,0,0,I,y),k.toBlob(C=>{if(!C){c(new Error("Failed to compress image"));return}const S=new File([C],n.name,{type:"image/jpeg",lastModified:Date.now()});console.log(`Original size: ${(n.size/1024).toFixed(2)}KB, Compressed size: ${(S.size/1024).toFixed(2)}KB`),r(S)},"image/jpeg",.8)},b.onerror=()=>{c(new Error("Failed to load image"))}},d.onerror=()=>{c(new Error("Failed to read file"))}}),V=async n=>{if(n.preventDefault(),!o.name.trim()){alert("Please enter an item name");return}try{if(g){const r={};if(o.name&&(r.name=o.name),o.url&&(r.url=o.url),o.quantity!==void 0&&(r.quantity=o.quantity),o.img){const c=new FormData;Object.keys(r).forEach(d=>{c.append(d,r[d])}),c.append("img",o.img),await i(g,c)}else await i(g,r);N(null)}else{const r={name:o.name,quantity:o.quantity};if(o.url&&(r.url=o.url),o.img){const c=new FormData;Object.keys(r).forEach(d=>{c.append(d,r[d])}),c.append("img",o.img),await q(c)}else await q(r)}v({name:"",img:null,url:"",quantity:0}),x(null)}catch(r){console.error("Failed to save item:",r)}},Y=n=>{v({name:n.name,img:null,url:n.url||"",quantity:n.quantity}),N(n.id),n.img&&x(n.img)},J=async(n,r)=>{if(window.confirm(`Delete "${r}"?`))try{await h(n)}catch(c){console.error("Failed to delete item:",c)}},O=async(n,r)=>{try{r==="add"?await L(n,1):await _(n,1)}catch(c){console.error("Failed to change quantity:",c)}},Z=async()=>{if(l.length===0){alert("No items to download");return}if(!t){s(!0);try{const n=(await ne(()=>import("./jspdf.es.min-720452b7.js").then(C=>C.j),["assets/jspdf.es.min-720452b7.js","assets/index-bbf9b331.js","assets/index-4a65fdae.css"])).jsPDF,r=new n({orientation:"portrait",unit:"mm",format:"a4"}),c=r.internal.pageSize.getWidth(),d=r.internal.pageSize.getHeight(),u=10,b=50,$=70,P=3,U=(c-u*2)/P;let I=1,y=0;r.setFontSize(16),r.text("Inventory QR Codes",u,u),r.setFontSize(10),r.text(`Generated: ${new Date().toLocaleDateString()}`,u,u+7);let k=u+15;const A=d-u;for(let C=0;C<l.length;C++){const S=l[C],ee=C%P,W=u+ee*U;try{const z=B(S.name,200),te=await(await fetch(z)).blob(),T=new FileReader;await new Promise(ae=>{T.onload=()=>{try{const M=T.result;r.addImage(M,"PNG",W+5,k,b,b),r.setFontSize(8),r.text(S.name,W+U/2,k+b+8,{align:"center",maxWidth:U-10}),y++,(y%P===0||y===l.length)&&(k+=$,k>A&&y<l.length&&(r.addPage(),I++,k=u))}catch(M){console.error(`Failed to add QR code for ${S.name}:`,M)}ae()},T.readAsDataURL(te)})}catch(z){console.error(`Failed to load QR code for ${S.name}:`,z)}}r.save(`inventory-qr-codes-${new Date().toISOString().split("T")[0]}.pdf`)}catch(n){console.error("Failed to download QR codes:",n),alert("Failed to download QR codes as PDF")}finally{s(!1)}}};return e.jsxs("div",{className:"p-8 lg:p-6 md:p-4 max-w-7xl mx-auto",children:[e.jsx("h1",{className:"text-3xl md:text-2xl font-bold mb-8 md:mb-6",children:"Inventory Management"}),f&&e.jsxs("div",{className:"mb-4 p-4 bg-red-100 text-red-700 rounded",children:["Error: ",f]}),e.jsxs("form",{onSubmit:V,className:"mb-8 md:mb-6 p-6 md:p-4 bg-gray-50 rounded-lg border",children:[e.jsx("h2",{className:"text-xl md:text-lg font-semibold mb-4",children:g?"Edit Item":"Add New Item"}),e.jsxs("div",{className:"grid grid-cols-4 lg:grid-cols-2 md:grid-cols-1 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Item Name *"}),e.jsx(H,{type:"text",name:"name",value:o.name,onChange:D,placeholder:"e.g., Sack Bag",disabled:!!g})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Image"}),e.jsx(H,{type:"file",name:"img",onChange:E,accept:"image/*",className:"cursor-pointer"}),a&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:a,alt:"Preview",className:"h-20 w-20 object-cover rounded border"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"URL"}),e.jsx(H,{type:"text",name:"url",value:o.url,onChange:D,placeholder:"https://example.com"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Quantity"}),e.jsx(H,{type:"number",name:"quantity",value:o.quantity,onChange:D,placeholder:"0"})]})]}),e.jsxs("div",{className:"flex gap-2 md:flex-col",children:[e.jsx(R,{type:"submit",className:"md:w-full",children:g?"Update Item":"Add Item"}),g&&e.jsx(R,{type:"button",variant:"outline",className:"md:w-full",onClick:()=>{N(null),v({name:"",img:null,url:"",quantity:0}),x(null)},children:"Cancel"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between md:flex-col md:gap-3 mb-4",children:[e.jsxs("h2",{className:"text-xl md:text-lg font-semibold",children:["Inventory Items (",l.length,")"]}),l.length>0&&e.jsx(R,{onClick:Z,disabled:t,className:"gap-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed md:w-full",children:t?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"inline-block animate-spin",children:"â³"}),"Generating PDF..."]}):e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"w-4 h-4"}),"Download All QR Codes (PDF)"]})})]}),w?e.jsx("p",{className:"text-gray-600",children:"Loading items..."}):l.length===0?e.jsx("p",{className:"text-gray-600",children:"No items in inventory"}):e.jsx("div",{className:"overflow-x-auto md:-mx-4",children:e.jsx("div",{className:"inline-block min-w-full align-middle",children:e.jsxs("table",{className:"min-w-full border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-200",children:[e.jsx("th",{className:"border p-3 md:p-2 text-left text-sm md:text-xs",children:"Item Name"}),e.jsx("th",{className:"border p-3 md:p-2 text-left text-sm md:text-xs",children:"Image"}),e.jsx("th",{className:"border p-3 md:p-2 text-left text-sm md:text-xs slg:hidden",children:"URL"}),e.jsx("th",{className:"border p-3 md:p-2 text-right text-sm md:text-xs",children:"Quantity"}),e.jsx("th",{className:"border p-3 md:p-2 text-center text-sm md:text-xs lg:hidden",children:"QR Code"}),e.jsx("th",{className:"border p-3 md:p-2 text-center text-sm md:text-xs",children:"Actions"})]})}),e.jsx("tbody",{children:l.map(n=>e.jsxs("tr",{className:"border hover:bg-gray-50",children:[e.jsx("td",{className:"border p-3 md:p-2 font-medium text-sm md:text-xs",children:n.name}),e.jsx("td",{className:"border p-3 md:p-2",children:n.img?e.jsx("div",{className:"flex justify-center",children:e.jsx("img",{src:n.img,alt:n.name,className:"w-[150px] h-[150px] object-contain rounded border"})}):e.jsx("div",{className:"flex justify-center items-center w-[150px] h-[150px]",children:e.jsx("span",{className:"text-gray-400 text-xs",children:"No image"})})}),e.jsx("td",{className:"border p-3 md:p-2 slg:hidden",children:n.url?e.jsx("a",{href:n.url,target:"_blank",rel:"noreferrer",className:"text-blue-600 hover:underline text-sm md:text-xs",children:"Link"}):e.jsx("span",{className:"text-gray-400 text-sm md:text-xs",children:"-"})}),e.jsx("td",{className:"border p-3 md:p-2 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2 md:gap-1",children:[e.jsx("button",{onClick:()=>O(n.id,"remove"),className:"px-2 py-1 md:px-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm md:text-xs",children:"-"}),e.jsx("span",{className:"w-8 md:w-6 text-center font-semibold text-sm md:text-xs",children:n.quantity}),e.jsx("button",{onClick:()=>O(n.id,"add"),className:"px-2 py-1 md:px-1.5 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm md:text-xs",children:"+"})]})}),e.jsx("td",{className:"border p-3 md:p-2 text-center lg:hidden",children:e.jsxs(R,{size:"sm",variant:"outline",onClick:()=>Q({name:n.name,id:n.id}),className:"gap-2 text-xs",children:[e.jsx(ie,{className:"w-4 h-4 md:w-3 md:h-3"}),e.jsx("span",{className:"slg:hidden",children:"Show QR"}),e.jsx("span",{className:"hidden slg:inline",children:"QR"})]})}),e.jsx("td",{className:"border p-3 md:p-2 text-center",children:e.jsxs("div",{className:"flex gap-2 md:gap-1 justify-center lg:flex-col",children:[e.jsx(R,{size:"sm",variant:"outline",onClick:()=>Y(n),className:"text-xs lg:w-full",children:"Edit"}),e.jsx(R,{size:"sm",variant:"outline",onClick:()=>J(n.id,n.name),className:"text-red-600 hover:text-red-700 text-xs lg:w-full",children:"Delete"})]})})]},n.id))})]})})})]}),j&&e.jsx(xe,{itemName:j.name,itemId:j.id,onClose:()=>Q(null)})]})},ge=({children:l})=>{const{isAuthenticated:w,isLoading:f}=re(),p=le();return f?e.jsx("div",{className:"min-h-screen w-full flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):w?e.jsx(e.Fragment,{children:l}):e.jsx(oe,{to:"/login",state:{from:p},replace:!0})},be=()=>e.jsx("div",{className:" min-h-full w-full max-w-[1468px]  flex flex-col justify-center",children:e.jsx(ge,{children:e.jsx(he,{})})});export{be as default};
